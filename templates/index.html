<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Document System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="ragApp()">
        <!-- í—¤ë” -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">RAG Document System</h1>
                    <p class="text-gray-600">ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ê³  ì§ˆë¬¸í•˜ì„¸ìš”!</p>
                </div>
                <button @click="showSettings = true"
                    class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200">
                    âš™ï¸ ì„¤ì •
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- ë¬¸ì„œ ì—…ë¡œë“œ íŒ¨ë„ -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ“„ ë¬¸ì„œ ì—…ë¡œë“œ</h2>

                    <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ -->
                    <div @drop="handleDrop" @dragover.prevent @dragenter.prevent
                        class="border-2 border-dashed border-gray-300 rounded-lg p-6 mb-4 text-center hover:border-blue-400 transition-colors"
                        :class="{'border-blue-400 bg-blue-50': isDragging}" @dragenter="isDragging = true"
                        @dragleave="isDragging = false" @drop="isDragging = false">
                        <div class="mb-4">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                viewBox="0 0 48 48">
                                <path
                                    d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                        <p class="text-gray-600 mb-2">íŒŒì¼ì´ë‚˜ í´ë”ë¥¼ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                        <p class="text-sm text-gray-500">ë˜ëŠ” ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                    </div>

                    <!-- íŒŒì¼/í´ë” ì„ íƒ ë²„íŠ¼ë“¤ -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button @click="$refs.fileInput.click()"
                            class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-200 transition duration-200">
                            ğŸ“„ íŒŒì¼ ì„ íƒ
                        </button>
                        <button @click="$refs.folderInput.click()"
                            class="bg-green-100 text-green-700 px-4 py-2 rounded-lg hover:bg-green-200 transition duration-200">
                            ğŸ“ í´ë” ì„ íƒ
                        </button>
                    </div>

                    <!-- ìˆ¨ê²¨ì§„ input ìš”ì†Œë“¤ -->
                    <input x-ref="fileInput" type="file" @change="handleFileSelect" accept=".pdf,.docx,.txt,.md"
                        multiple class="hidden">
                    <input x-ref="folderInput" type="file" @change="handleFolderSelect" webkitdirectory class="hidden">

                    <!-- ì„ íƒëœ íŒŒì¼ ëª©ë¡ -->
                    <div x-show="selectedFiles.length > 0" class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">ì„ íƒëœ íŒŒì¼:</h3>
                        <div class="max-h-32 overflow-y-auto bg-gray-50 rounded p-2">
                            <template x-for="file in selectedFiles" :key="file.name + file.size">
                                <div class="flex justify-between items-center text-xs py-1">
                                    <div class="flex-1">
                                        <span x-text="file.webkitRelativePath || file.name" class="truncate"></span>
                                        <div x-show="file.webkitRelativePath" class="text-gray-400 text-xs">
                                            í´ë”: <span
                                                x-text="file.webkitRelativePath.split('/').slice(0, -1).join('/')"></span>
                                        </div>
                                    </div>
                                    <span x-text="(file.size / 1024).toFixed(1) + ' KB'"
                                        class="text-gray-500 ml-2"></span>
                                    <button @click="removeFile(file)"
                                        class="text-red-500 hover:text-red-700 ml-2">âœ•</button>
                                </div>
                            </template>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ì´ <span x-text="selectedFiles.length"></span>ê°œ íŒŒì¼</p>
                    </div>

                    <!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë˜ëŠ” ì§ì ‘ í…ìŠ¤íŠ¸ ì…ë ¥</label>
                        <input type="text" x-model="documentTitle" placeholder="ë¬¸ì„œ ì œëª©"
                            class="w-full p-2 border border-gray-300 rounded-lg mb-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <textarea x-model="documentContent" placeholder="ë¬¸ì„œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="6"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>

                    <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
                    <button @click="uploadDocument" :disabled="uploading"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition duration-200">
                        <span x-show="!uploading">ğŸ“¤ ì—…ë¡œë“œ</span>
                        <span x-show="uploading">â³ ì—…ë¡œë“œ ì¤‘...</span>
                    </button>

                    <!-- ì—…ë¡œë“œ ì§„í–‰ë¥  -->
                    <div x-show="uploading && uploadProgress > 0" class="mt-4">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                :style="'width: ' + uploadProgress + '%'"></div>
                        </div>
                        <p class="text-xs text-gray-600 mt-1">
                            ì—…ë¡œë“œ ì¤‘... <span x-text="uploadProgress"></span>%
                            (<span x-text="currentFileIndex"></span>/<span x-text="totalFiles"></span>)
                        </p>
                    </div>

                    <!-- ì—…ë¡œë“œ ìƒíƒœ -->
                    <div x-show="uploadStatus" class="mt-4 p-3 rounded-lg"
                        :class="uploadSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                        x-text="uploadStatus"></div>

                    <!-- ë¬¸ì„œ í†µê³„ -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold mb-2">ğŸ“Š ë¬¸ì„œ í†µê³„</h3>
                        <p class="text-sm text-gray-600">ì´ ë¬¸ì„œ ìˆ˜: <span x-text="documentCount"
                                class="font-semibold"></span></p>
                        <button @click="refreshStats" class="text-blue-600 text-sm hover:underline mt-1">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>
            </div>

            <!-- ì±„íŒ… íŒ¨ë„ -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md h-[900px] flex flex-col">
                    <!-- ì±„íŒ… í—¤ë” -->
                    <div class="p-4 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-800">ğŸ’¬ ì§ˆë¬¸í•˜ê¸°</h2>
                        <p class="text-sm text-gray-600">ì—…ë¡œë“œëœ ë¬¸ì„œë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸ì— ë‹µë³€í•´ë“œë¦½ë‹ˆë‹¤.</p>
                    </div>

                    <!-- ë©”ì‹œì§€ ëª©ë¡ -->
                    <div class="flex-1 p-4 overflow-y-auto" id="messageContainer">
                        <template x-for="message in messages" :key="message.id">
                            <div class="mb-4">
                                <!-- ì‚¬ìš©ì ë©”ì‹œì§€ -->
                                <div x-show="message.type === 'user'" class="flex justify-end">
                                    <div class="bg-blue-600 text-white p-3 rounded-lg max-w-[80%]">
                                        <p x-text="message.content"></p>
                                        <div class="text-xs text-blue-100 mt-1" x-text="message.timestamp"></div>
                                    </div>
                                </div>

                                <!-- AI ì‘ë‹µ -->
                                <div x-show="message.type === 'assistant'" class="flex justify-start">
                                    <div class="bg-gray-100 text-gray-800 p-3 rounded-lg max-w-[80%]">
                                        <!-- ì¿¼ë¦¬ ë¶„ì„ ì •ë³´ í‘œì‹œ -->
                                        <div x-show="message.query_analysis"
                                            class="mb-2 p-2 bg-blue-50 rounded text-xs">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="font-semibold">ğŸ” ì§ˆë¬¸ ë¶„ì„:</span>
                                                <span
                                                    x-show="message.query_analysis && message.query_analysis.query_type === 'greeting'"
                                                    class="bg-green-100 text-green-800 px-2 py-1 rounded">ì¸ì‚¬</span>
                                                <span
                                                    x-show="message.query_analysis && message.query_analysis.query_type === 'general_knowledge'"
                                                    class="bg-blue-100 text-blue-800 px-2 py-1 rounded">ì¼ë°˜ ì§€ì‹</span>
                                                <span
                                                    x-show="message.query_analysis && message.query_analysis.query_type === 'system_info'"
                                                    class="bg-purple-100 text-purple-800 px-2 py-1 rounded">ì‹œìŠ¤í…œ
                                                    ì •ë³´</span>
                                                <span
                                                    x-show="message.query_analysis && message.query_analysis.query_type === 'document_search'"
                                                    class="bg-orange-100 text-orange-800 px-2 py-1 rounded">ë¬¸ì„œ ê²€ìƒ‰</span>
                                            </div>
                                            <div class="text-gray-600">
                                                <span x-show="message.used_documents === false">ğŸ“ ë¬¸ì„œ ì—†ì´ ë‹µë³€ ìƒì„±</span>
                                                <span x-show="message.used_documents === true">ğŸ“š ë¬¸ì„œ ê¸°ë°˜ ë‹µë³€ ìƒì„±</span>
                                                <span
                                                    x-show="message.query_analysis && message.query_analysis.keywords && message.query_analysis.keywords.length > 0"
                                                    class="ml-2">
                                                    | í‚¤ì›Œë“œ: <span
                                                        x-text="(message.query_analysis && message.query_analysis.keywords) ? message.query_analysis.keywords.join(', ') : ''"></span>
                                                </span>
                                            </div>
                                        </div>
                                        <p x-text="message.content" class="whitespace-pre-wrap"></p>
                                        <div x-show="message.sources && message.sources.length > 0" class="mt-3">
                                            <p class="text-xs font-semibold text-gray-600 mb-1">ğŸ“š ì°¸ì¡° ë¬¸ì„œ:</p>
                                            <template x-for="(source, index) in message.sources"
                                                :key="source.unique_chunk_index || source.document_id + '_' + index">
                                                <div class="bg-blue-50 p-2 rounded text-xs mb-1">
                                                    <div class="flex justify-between items-start mb-1">
                                                        <div class="flex-1">
                                                            <p class="font-semibold"
                                                                x-text="(source.metadata && source.metadata.title) || 'ì•Œ ìˆ˜ ì—†ëŠ” ë¬¸ì„œ'">
                                                            </p>
                                                            <p class="text-xs text-gray-500"
                                                                x-text="'ì²­í¬ ID: ' + (source.unique_chunk_index || source.document_id + '#' + ((source.metadata && source.metadata.chunk_index) || index))">
                                                            </p>
                                                        </div>
                                                        <button @click="viewChunkContent(source)"
                                                            class="ml-2 text-blue-600 hover:text-blue-800 text-xs underline">
                                                            ì²­í¬ ë³´ê¸°
                                                        </button>
                                                    </div>
                                                    <p class="text-gray-600 mt-1"
                                                        x-text="(source.content || 'ë‚´ìš© ì—†ìŒ').substring(0, 100) + (source.content && source.content.length > 100 ? '...' : '')">
                                                    </p>
                                                    <p class="text-blue-600 mt-1">ìœ ì‚¬ë„: <span
                                                            x-text="source.score ? (source.score * 100).toFixed(1) : '0.0'"></span>%
                                                    </p>
                                                </div>
                                            </template>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1" x-text="message.timestamp"></div>
                                    </div>
                                </div>

                                <!-- ë¡œë”© ë©”ì‹œì§€ -->
                                <div x-show="message.type === 'loading'" class="flex justify-start">
                                    <div class="bg-gray-100 text-gray-800 p-3 rounded-lg">
                                        <div class="flex items-center">
                                            <div
                                                class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2">
                                            </div>
                                            <span>ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- ì…ë ¥ ì˜ì—­ -->
                    <div class="p-4 border-t border-gray-200">
                        <div class="flex gap-2">
                            <input type="text" x-model="currentQuestion" @keyup.enter="askQuestion"
                                placeholder="ë¬¸ì„œì— ëŒ€í•´ ì§ˆë¬¸í•´ë³´ì„¸ìš”..." :disabled="questioning"
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:bg-gray-100">
                            <button @click="askQuestion" :disabled="questioning || !currentQuestion.trim()"
                                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition duration-200">
                                <span x-show="!questioning">ì „ì†¡</span>
                                <span x-show="questioning">â³</span>
                            </button>
                        </div>

                        <!-- ê²€ìƒ‰ ì „ëµ ì˜µì…˜ -->
                        <div class="mt-2">
                            <span class="text-sm text-gray-600 mb-2 block">ê²€ìƒ‰ ì „ëµ:</span>

                            <!-- 1ë‹¨ê³„: ê¸°ë³¸ ì „ëµ ì„ íƒ -->
                            <div class="mb-3">
                                <div class="flex flex-wrap gap-2">
                                    <button @click="selectBaseStrategy('dense')"
                                        :class="baseStrategy === 'dense' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                        class="px-3 py-1 rounded-lg text-sm transition duration-200 hover:bg-blue-500 hover:text-white">
                                        Dense ê²€ìƒ‰
                                    </button>
                                    <button @click="selectBaseStrategy('sparse')"
                                        :class="baseStrategy === 'sparse' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                        class="px-3 py-1 rounded-lg text-sm transition duration-200 hover:bg-blue-500 hover:text-white">
                                        Sparse ê²€ìƒ‰
                                    </button>
                                    <button @click="selectBaseStrategy('hybrid')"
                                        :class="baseStrategy === 'hybrid' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                        class="px-3 py-1 rounded-lg text-sm transition duration-200 hover:bg-blue-500 hover:text-white">
                                        Hybrid ê²€ìƒ‰
                                    </button>
                                    <button @click="selectBaseStrategy('bm25')"
                                        :class="baseStrategy === 'bm25' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                        class="px-3 py-1 rounded-lg text-sm transition duration-200 hover:bg-blue-500 hover:text-white">
                                        BM25 ê²€ìƒ‰
                                    </button>
                                </div>
                            </div>

                            <!-- 2ë‹¨ê³„: BM25 í˜•íƒœì†Œ ë¶„ì„ê¸° ì„ íƒ (BM25 ì„ íƒì‹œë§Œ í‘œì‹œ) -->
                            <div x-show="baseStrategy === 'bm25'" x-transition class="mb-3">
                                <span class="text-xs text-gray-600 mb-2 block">í˜•íƒœì†Œ ë¶„ì„ê¸°:</span>
                                <div class="flex flex-wrap gap-2">
                                    <button @click="selectAnalyzer('none')"
                                        :class="selectedAnalyzer === 'none' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-600'"
                                        class="px-2 py-1 rounded text-xs transition duration-200 hover:bg-green-500 hover:text-white">
                                        ì—†ìŒ
                                    </button>
                                    <button @click="selectAnalyzer('kkma')"
                                        :class="selectedAnalyzer === 'kkma' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-600'"
                                        class="px-2 py-1 rounded text-xs transition duration-200 hover:bg-green-500 hover:text-white">
                                        KKMA
                                    </button>
                                    <button @click="selectAnalyzer('okt')"
                                        :class="selectedAnalyzer === 'okt' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-600'"
                                        class="px-2 py-1 rounded text-xs transition duration-200 hover:bg-green-500 hover:text-white">
                                        OKT
                                    </button>
                                    <button @click="selectAnalyzer('kiwi')"
                                        :class="selectedAnalyzer === 'kiwi' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-600'"
                                        class="px-2 py-1 rounded text-xs transition duration-200 hover:bg-green-500 hover:text-white">
                                        Kiwi
                                    </button>
                                    <button @click="selectAnalyzer('komoran')"
                                        :class="selectedAnalyzer === 'komoran' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-600'"
                                        class="px-2 py-1 rounded text-xs transition duration-200 hover:bg-green-500 hover:text-white">
                                        Komoran
                                    </button>
                                    <button @click="selectAnalyzer('hannanum')"
                                        :class="selectedAnalyzer === 'hannanum' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-600'"
                                        class="px-2 py-1 rounded text-xs transition duration-200 hover:bg-green-500 hover:text-white">
                                        Hannanum
                                    </button>
                                </div>
                            </div>

                            <!-- 3ë‹¨ê³„: Hybrid ì˜µì…˜ (BM25 ì„ íƒì‹œë§Œ í‘œì‹œ) -->
                            <div x-show="baseStrategy === 'bm25'" x-transition class="mb-3">
                                <span class="text-xs text-gray-600 mb-2 block">í•˜ì´ë¸Œë¦¬ë“œ ì˜µì…˜:</span>
                                <div class="flex gap-2">
                                    <button @click="toggleHybrid(false)"
                                        :class="!useHybrid ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-600'"
                                        class="px-2 py-1 rounded text-xs transition duration-200 hover:bg-purple-500 hover:text-white">
                                        ì¼ë°˜
                                    </button>
                                    <button @click="toggleHybrid(true)"
                                        :class="useHybrid ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-600'"
                                        class="px-2 py-1 rounded text-xs transition duration-200 hover:bg-purple-500 hover:text-white">
                                        í•˜ì´ë¸Œë¦¬ë“œ
                                    </button>
                                </div>
                            </div>

                            <!-- ìµœì¢… ì„ íƒëœ ì „ëµ í‘œì‹œ -->
                            <div class="mt-2 p-2 bg-blue-50 rounded-lg">
                                <span class="text-xs font-medium text-blue-800">ì„ íƒëœ ì „ëµ: </span>
                                <span class="text-xs text-blue-600 font-mono" x-text="searchStrategy"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì„¤ì • ëª¨ë‹¬ -->
        <div x-show="showSettings" x-transition
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            @click.self="showSettings = false">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h2>
                        <button @click="showSettings = false" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8">
                            <button @click="activeTab = 'parsing'"
                                :class="activeTab === 'parsing' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                ğŸ“„ íŒŒì‹± ì„¤ì •
                            </button>
                            <button @click="activeTab = 'chunking'"
                                :class="activeTab === 'chunking' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                ğŸ“ ì²­í‚¹ ì„¤ì •
                            </button>
                            <button @click="activeTab = 'embedding'"
                                :class="activeTab === 'embedding' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                ğŸ”® ì„ë² ë”© ì„¤ì •
                            </button>
                            <button @click="activeTab = 'retrieval'"
                                :class="activeTab === 'retrieval' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                ğŸ” ê²€ìƒ‰ ì„¤ì •
                            </button>
                            <button @click="activeTab = 'llm'"
                                :class="activeTab === 'llm' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                ğŸ¤– LLM ì„¤ì •
                            </button>
                        </nav>
                    </div>

                    <!-- ì„¤ì • ì»¨í…ì¸  -->
                    <div class="max-h-[50vh] overflow-y-auto">
                        <!-- íŒŒì‹± ì„¤ì • íƒ­ -->
                        <div x-show="activeTab === 'parsing'" class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-700">ğŸ“„ ë¬¸ì„œ íŒŒì„œ ì„¤ì •</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">íŒŒì„œ ìœ í˜•</label>
                                <select x-model="settings.parser.parser_type"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="docling">Docling (ê³ ê¸‰ ë¬¸ì„œ êµ¬ì¡° ë¶„ì„)</option>
                                    <option value="pdfminer">PDFMiner (í…ìŠ¤íŠ¸ ì¤‘ì‹¬)</option>
                                    <option value="pdfplumber">PDFPlumber (í‘œ ë° ë ˆì´ì•„ì›ƒ)</option>
                                    <option value="pypdf">PyPDF (ê°„ë‹¨í•œ PDF ì²˜ë¦¬)</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">
                                    ë¬¸ì„œ ìœ í˜•ì— ë”°ë¼ ì ì ˆí•œ íŒŒì„œë¥¼ ì„ íƒí•˜ì„¸ìš”. Doclingì€ ë³µì¡í•œ ë¬¸ì„œ êµ¬ì¡°ì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                                </p>
                            </div>
                        </div>

                        <!-- ì²­í‚¹ ì„¤ì • íƒ­ -->
                        <div x-show="activeTab === 'chunking'" class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-700">ğŸ“ í…ìŠ¤íŠ¸ ì²­í‚¹ ì„¤ì •</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì²­í‚¹ ë°©ë²•</label>
                                <select x-model="settings.chunking.method"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="token_sentence">í† í°-ë¬¸ì¥ ê¸°ë°˜ (ê· í˜•ì¡íŒ ë¶„í• )</option>
                                    <option value="sentence_window">ë¬¸ì¥ ìœˆë„ìš° (ë¬¸ë§¥ ë³´ì¡´)</option>
                                    <option value="recursive_character">ì¬ê·€ì  ë¬¸ì ë¶„í•  (ìœ ì—°í•œ ë¶„í• )</option>
                                    <option value="semantic_chunker">ì˜ë¯¸ì  ì²­í‚¹ (ì„ë² ë”© ê¸°ë°˜)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì²­í¬ í¬ê¸°</label>
                                <input type="number" x-model="settings.chunking.chunk_size" min="100" max="2048"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">
                                    ì²­í¬ë‹¹ í† í° ìˆ˜. ë„ˆë¬´ ì‘ìœ¼ë©´ ë¬¸ë§¥ì´ ë¶€ì¡±í•˜ê³ , ë„ˆë¬´ í¬ë©´ ì •í™•ë„ê°€ ë–¨ì–´ì§‘ë‹ˆë‹¤. (ê¶Œì¥: 256-512)
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ê²¹ì¹¨ í¬ê¸°</label>
                                <input type="number" x-model="settings.chunking.overlap" min="0" max="200"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">
                                    ì¸ì ‘ ì²­í¬ ê°„ ê²¹ì¹˜ëŠ” í† í° ìˆ˜. ë¬¸ë§¥ ì—°ì†ì„±ì„ ìœ„í•´ ì„¤ì •í•©ë‹ˆë‹¤. (ê¶Œì¥: 50-100)
                                </p>
                            </div>
                        </div>

                        <!-- ì„ë² ë”© ì„¤ì • íƒ­ -->
                        <div x-show="activeTab === 'embedding'" class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-700">ğŸ”® ì„ë² ë”© ëª¨ë¸ ì„¤ì •</h3>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                                clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h4 class="text-sm font-medium text-yellow-800">âš ï¸ ì¤‘ìš” ì•ˆë‚´</h4>
                                        <p class="text-sm text-yellow-700 mt-1">
                                            ì„ë² ë”© ëª¨ë¸ì„ ë³€ê²½í•˜ë©´ ê¸°ì¡´ì˜ ëª¨ë“  ë²¡í„°ìŠ¤í† ì–´ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.
                                            ë³€ê²½ í›„ ë¬¸ì„œë¥¼ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì„ë² ë”© ëª¨ë¸</label>
                                <input type="text" x-model="settings.embedding.model_name"
                                    class="w-full p-2 border border-gray-300 rounded-lg"
                                    placeholder="ì˜ˆ: jinaai/jina-embeddings-v3">
                                <p class="text-xs text-gray-500 mt-1">
                                    HuggingFaceì˜ ì„ë² ë”© ëª¨ë¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”. í•œêµ­ì–´ ë¬¸ì„œì—ëŠ” multilingual ëª¨ë¸ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                                </p>
                                <div class="mt-2 text-xs text-gray-500">
                                    <p><strong>ì¶”ì²œ ëª¨ë¸:</strong></p>
                                    <ul class="list-disc pl-5 mt-1">
                                        <li>jinaai/jina-embeddings-v3 (ìµœì‹ , ë‹¤êµ­ì–´)</li>
                                        <li>BAAI/bge-m3 (ë‹¤êµ­ì–´ ì§€ì›)</li>
                                        <li>dragonkue/BGE-m3-ko (í•œêµ­ì–´ ìµœì í™”)</li>
                                        <li>sentence-transformers/all-MiniLM-L6-v2 (ê²½ëŸ‰)</li>
                                        <li>intfloat/multilingual-e5-large (ê³ ì„±ëŠ¥)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- ê²€ìƒ‰ ì„¤ì • íƒ­ -->
                        <div x-show="activeTab === 'retrieval'" class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-700">ğŸ” ê²€ìƒ‰ ì„¤ì •</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ê²€ìƒ‰ ê²°ê³¼ ìˆ˜</label>
                                <input type="number" x-model="settings.retrieval.search_limit" min="1" max="20"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">
                                    ê²€ìƒ‰ ì‹œ ë°˜í™˜í•  ìµœëŒ€ ì²­í¬ ìˆ˜. ë§ì„ìˆ˜ë¡ ë” ë§ì€ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•˜ì§€ë§Œ ì‘ë‹µì´ ëŠë ¤ì§‘ë‹ˆë‹¤.
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ìœ ì‚¬ë„ ì„ê³„ê°’</label>
                                <input type="range" x-model="settings.retrieval.score_threshold" min="0" max="1"
                                    step="0.1" class="w-full">
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>ë‚®ìŒ (0.0)</span>
                                    <span x-text="settings.retrieval.score_threshold"></span>
                                    <span>ë†’ìŒ (1.0)</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">
                                    ìµœì†Œ ìœ ì‚¬ë„ ì ìˆ˜. ë†’ì„ìˆ˜ë¡ ë” ê´€ë ¨ì„± ë†’ì€ ê²°ê³¼ë§Œ ë°˜í™˜í•©ë‹ˆë‹¤.
                                </p>
                            </div>
                        </div>

                        <!-- LLM ì„¤ì • íƒ­ -->
                        <div x-show="activeTab === 'llm'" class="space-y-4">
                            <h3 class="text-lg font-semibold text-gray-700">ğŸ¤– LLM ì„¤ì •</h3>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì œê³µì</label>
                                <select x-model="settings.llm.provider"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option value="openai">OpenAI</option>
                                    <option value="gemini">Google Gemini</option>
                                    <option value="vllm">vLLM</option>
                                    <option value="ollama">Ollama</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ëª¨ë¸ ì´ë¦„</label>
                                <input type="text" x-model="settings.llm.model_name"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">API í‚¤</label>
                                <input type="password" x-model="settings.llm.api_key" placeholder="í™˜ê²½ë³€ìˆ˜ì—ì„œ ìë™ ë¡œë“œë¨"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div x-show="settings.llm.provider === 'vllm'">
                                <label class="block text-sm font-medium text-gray-700 mb-2">vLLM Base URL</label>
                                <input type="url" x-model="settings.llm.vllm_base_url"
                                    placeholder="http://localhost:8000"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div x-show="settings.llm.provider === 'ollama'">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ollama Base URL</label>
                                <input type="url" x-model="settings.llm.ollama_base_url"
                                    placeholder="http://localhost:11434"
                                    class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Temperature</label>
                                <input type="range" x-model="settings.llm.temperature" min="0" max="1" step="0.1"
                                    class="w-full">
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>ê²°ì •ì  (0.0)</span>
                                    <span x-text="settings.llm.temperature"></span>
                                    <span>ì°½ì˜ì  (1.0)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ë²„íŠ¼ -->
                    <div class="flex gap-3 mt-6 pt-4 border-t border-gray-200">
                        <button @click="loadSettings"
                            class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-200">
                            í˜„ì¬ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                        <button @click="saveSettings"
                            class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200">
                            ì„¤ì • ì €ì¥
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì „ì²´ ë‚´ìš© ë³´ê¸° ëª¨ë‹¬ -->
        <div x-show="showFullContent" x-transition
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            @click.self="showFullContent = false">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800" x-text="fullContentDocument.title || 'ì²­í¬ ë‚´ìš©'">
                            </h2>
                            <p class="text-sm text-gray-500" x-text="fullContentDocument.chunkId"></p>
                        </div>
                        <button @click="showFullContent = false" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="max-h-[70vh] overflow-y-auto bg-gray-50 p-4 rounded-lg">
                        <div x-show="loadingFullContent" class="text-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2">
                            </div>
                            <p class="text-gray-600">ì²­í¬ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                        <div x-show="!loadingFullContent" class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="text-sm text-gray-800 whitespace-pre-wrap" x-text="fullContentDocument.content">
                            </div>
                            <!-- ë©”íƒ€ë°ì´í„° í‘œì‹œ -->
                            <div x-show="fullContentDocument.metadata" class="mt-4 pt-4 border-t border-gray-200">
                                <h4 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“„ ë©”íƒ€ë°ì´í„°</h4>
                                <div class="text-xs text-gray-600 space-y-1">
                                    <div x-show="fullContentDocument.score">
                                        ìœ ì‚¬ë„: <span x-text="(fullContentDocument.score * 100).toFixed(1)"></span>%
                                    </div>
                                    <div x-show="fullContentDocument.documentId">
                                        ë¬¸ì„œ ID: <span x-text="fullContentDocument.documentId"></span>
                                    </div>
                                    <div x-show="fullContentDocument.chunkIndex !== undefined">
                                        ì²­í¬ ì¸ë±ìŠ¤: <span x-text="fullContentDocument.chunkIndex"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function ragApp() {
            return {
                // ë¬¸ì„œ ì—…ë¡œë“œ ê´€ë ¨
                selectedFiles: [],
                documentTitle: '',
                documentContent: '',
                uploading: false,
                uploadStatus: '',
                uploadSuccess: false,
                documentCount: 0,
                isDragging: false,
                uploadProgress: 0,
                currentFileIndex: 0,
                totalFiles: 0,

                // ì±„íŒ… ê´€ë ¨
                messages: [],
                currentQuestion: '',
                questioning: false,
                searchStrategy: 'hybrid',

                // ê²€ìƒ‰ ì „ëµ ì„ íƒ ê´€ë ¨ ì¶”ê°€
                baseStrategy: 'hybrid',
                selectedAnalyzer: 'none',
                useHybrid: false,

                // ì„¤ì • ê´€ë ¨
                showSettings: false,
                activeTab: 'parsing',
                settings: {
                    chunking: {
                        method: 'token_sentence',
                        chunk_size: 512,
                        overlap: 50,
                        unit: 'token'
                    },
                    llm: {
                        provider: 'openai',
                        model_name: 'gpt-3.5-turbo',
                        api_key: '',
                        temperature: 0.1,
                        vllm_base_url: 'http://localhost:8000',
                        ollama_base_url: 'http://localhost:11434'
                    },
                    parser: {
                        parser_type: 'docling'
                    },
                    embedding: {
                        model_name: 'jinaai/jina-embeddings-v3'
                    },
                    retrieval: {
                        search_limit: 5,
                        score_threshold: 0.3,
                    }
                },

                // ì „ì²´ ë‚´ìš© ë³´ê¸° ê´€ë ¨
                showFullContent: false,
                loadingFullContent: false,
                fullContentDocument: {
                    title: '',
                    content: '',
                    chunkId: '',
                    documentId: '',
                    chunkIndex: null,
                    score: null,
                    metadata: false
                },

                init() {
                    this.refreshStats();
                    this.loadSettings();
                    this.updateSearchStrategy(); // ì´ˆê¸° ì „ëµ ì„¤ì •
                },

                async loadSettings() {
                    try {
                        const response = await fetch('/settings');
                        if (response.ok) {
                            this.settings = await response.json();
                        }
                    } catch (error) {
                        console.error('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                    }
                },

                async saveSettings() {
                    try {
                        // í˜„ì¬ ì„¤ì •ê³¼ ìƒˆ ì„¤ì • ë¹„êµí•˜ì—¬ ì„ë² ë”© ëª¨ë¸ ë³€ê²½ í™•ì¸
                        const currentResponse = await fetch('/settings');
                        const currentSettings = await currentResponse.json();

                        const embeddingChanged = currentSettings.embedding.model_name !== this.settings.embedding.model_name;

                        // ì„ë² ë”© ëª¨ë¸ì´ ë³€ê²½ëœ ê²½ìš° ê²½ê³  í‘œì‹œ
                        if (embeddingChanged) {
                            const confirmed = confirm(
                                'âš ï¸ ì„ë² ë”© ëª¨ë¸ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n' +
                                'ì„ë² ë”© ëª¨ë¸ì„ ë³€ê²½í•˜ë©´ ê¸°ì¡´ì˜ ëª¨ë“  ë²¡í„°ìŠ¤í† ì–´ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.\n' +
                                'ë³€ê²½ í›„ì—ëŠ” ë¬¸ì„œë¥¼ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.\n\n' +
                                'ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
                            );

                            if (!confirmed) {
                                // ì·¨ì†Œëœ ê²½ìš° ì›ë˜ ì„¤ì •ìœ¼ë¡œ ë˜ëŒë¦¼
                                this.settings.embedding.model_name = currentSettings.embedding.model_name;
                                return;
                            }
                        }

                        const response = await fetch('/settings', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.settings)
                        });

                        if (response.ok) {
                            const result = await response.json();

                            if (result.embedding_changed) {
                                // ì„ë² ë”© ëª¨ë¸ì´ ë³€ê²½ëœ ê²½ìš° ë²¡í„°ìŠ¤í† ì–´ ì¬ì´ˆê¸°í™”
                                const reinitialize = confirm(
                                    'âœ… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n' +
                                    'ì„ë² ë”© ëª¨ë¸ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ê¸ˆ ë²¡í„°ìŠ¤í† ì–´ë¥¼ ì¬ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n' +
                                    '(ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ì¬ì´ˆê¸°í™”í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤)'
                                );

                                if (reinitialize) {
                                    await this.reinitializeVectorStore();
                                }
                            } else {
                                alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }

                            this.showSettings = false;
                        } else {
                            throw new Error('ì„¤ì • ì €ì¥ ì‹¤íŒ¨');
                        }
                    } catch (error) {
                        console.error('ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
                        alert('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    }
                },

                async reinitializeVectorStore() {
                    try {
                        const response = await fetch('/vectorstore/reinitialize', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            alert('âœ… ' + result.message);
                            // ë¬¸ì„œ í†µê³„ ìƒˆë¡œê³ ì¹¨
                            this.refreshStats();
                        } else {
                            throw new Error('ë²¡í„°ìŠ¤í† ì–´ ì¬ì´ˆê¸°í™” ì‹¤íŒ¨');
                        }
                    } catch (error) {
                        console.error('ë²¡í„°ìŠ¤í† ì–´ ì¬ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                        alert('ë²¡í„°ìŠ¤í† ì–´ ì¬ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    }
                },

                // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
                handleDrop(event) {
                    event.preventDefault();
                    const files = Array.from(event.dataTransfer.files);
                    const items = Array.from(event.dataTransfer.items);

                    // í´ë”ê°€ ë“œë¡­ëœ ê²½ìš° ì²˜ë¦¬
                    if (items.length > 0 && items[0].webkitGetAsEntry) {
                        this.handleDroppedItems(items);
                    } else {
                        this.addFiles(files);
                    }
                },

                // ë“œë¡­ëœ ì•„ì´í…œë“¤ ì²˜ë¦¬ (í´ë” í¬í•¨)
                async handleDroppedItems(items) {
                    const allFiles = [];

                    for (const item of items) {
                        const entry = item.webkitGetAsEntry();
                        if (entry) {
                            const files = await this.processEntry(entry);
                            allFiles.push(...files);
                        }
                    }

                    this.addFiles(allFiles);
                },

                // íŒŒì¼/í´ë” ì—”íŠ¸ë¦¬ ì²˜ë¦¬
                async processEntry(entry) {
                    if (entry.isFile) {
                        return new Promise((resolve) => {
                            entry.file((file) => {
                                if (this.isValidFileType(file)) {
                                    resolve([file]);
                                } else {
                                    resolve([]);
                                }
                            });
                        });
                    } else if (entry.isDirectory) {
                        const files = [];
                        const dirReader = entry.createReader();

                        return new Promise((resolve) => {
                            const readEntries = async () => {
                                dirReader.readEntries(async (entries) => {
                                    if (entries.length === 0) {
                                        resolve(files);
                                        return;
                                    }

                                    for (const subEntry of entries) {
                                        const subFiles = await this.processEntry(subEntry);
                                        files.push(...subFiles);
                                    }

                                    readEntries(); // ì¬ê·€ì ìœ¼ë¡œ ë” ë§ì€ ì—”íŠ¸ë¦¬ ì½ê¸°
                                });
                            };
                            readEntries();
                        });
                    }
                    return [];
                },

                // íŒŒì¼ íƒ€ì… ê²€ì¦
                isValidFileType(file) {
                    const validTypes = ['.pdf', '.docx', '.txt', '.md'];
                    const fileName = file.name.toLowerCase();
                    return validTypes.some(type => fileName.endsWith(type));
                },

                // íŒŒì¼ ì„ íƒ ì²˜ë¦¬
                handleFileSelect(event) {
                    const files = Array.from(event.target.files);
                    this.addFiles(files);
                },

                // í´ë” ì„ íƒ ì²˜ë¦¬
                handleFolderSelect(event) {
                    const files = Array.from(event.target.files);
                    this.addFiles(files);
                },

                // íŒŒì¼ ì¶”ê°€
                addFiles(files) {
                    const validFiles = files.filter(file => this.isValidFileType(file));

                    // ì¤‘ë³µ íŒŒì¼ ì œê±°
                    for (const file of validFiles) {
                        const exists = this.selectedFiles.some(existingFile =>
                            existingFile.name === file.name && existingFile.size === file.size
                        );
                        if (!exists) {
                            this.selectedFiles.push(file);
                        }
                    }

                    if (validFiles.length !== files.length) {
                        this.uploadStatus = `${files.length - validFiles.length}ê°œ íŒŒì¼ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” í˜•ì‹ì…ë‹ˆë‹¤.`;
                        this.uploadSuccess = false;
                    }
                },

                // íŒŒì¼ ì œê±°
                removeFile(fileToRemove) {
                    this.selectedFiles = this.selectedFiles.filter(file => file !== fileToRemove);
                },

                // ë¬¸ì„œ ì—…ë¡œë“œ
                async uploadDocument() {
                    if (this.selectedFiles.length === 0 && (!this.documentTitle || !this.documentContent)) {
                        this.uploadStatus = 'íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                        this.uploadSuccess = false;
                        return;
                    }

                    this.uploading = true;
                    this.uploadStatus = '';
                    this.uploadProgress = 0;
                    this.currentFileIndex = 0;

                    try {
                        if (this.selectedFiles.length > 0) {
                            // ì—¬ëŸ¬ íŒŒì¼ ì—…ë¡œë“œ
                            this.totalFiles = this.selectedFiles.length;
                            let successCount = 0;
                            let failedFiles = [];

                            for (let i = 0; i < this.selectedFiles.length; i++) {
                                this.currentFileIndex = i + 1;
                                const file = this.selectedFiles[i];

                                try {
                                    const formData = new FormData();
                                    formData.append('file', file);

                                    // í´ë” ì •ë³´ ì¶”ê°€
                                    if (file.webkitRelativePath) {
                                        const pathParts = file.webkitRelativePath.split('/');
                                        const folderPath = pathParts.slice(0, -1).join('/');
                                        const folderName = pathParts[0]; // ìµœìƒìœ„ í´ë”ëª…

                                        formData.append('folder_path', folderPath);
                                        formData.append('folder_name', folderName);
                                    }

                                    const response = await fetch('/documents/upload', {
                                        method: 'POST',
                                        body: formData
                                    });

                                    if (response.ok) {
                                        successCount++;
                                    } else {
                                        const error = await response.json();
                                        failedFiles.push(`${file.name}: ${error.detail || 'ì—…ë¡œë“œ ì‹¤íŒ¨'}`);
                                    }
                                } catch (error) {
                                    failedFiles.push(`${file.name}: ${error.message}`);
                                }

                                this.uploadProgress = Math.round((i + 1) / this.selectedFiles.length * 100);
                            }

                            // ê²°ê³¼ ë©”ì‹œì§€
                            if (successCount === this.selectedFiles.length) {
                                this.uploadStatus = `ëª¨ë“  íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! (${successCount}ê°œ)`;
                                this.uploadSuccess = true;
                                this.selectedFiles = [];
                            } else if (successCount > 0) {
                                this.uploadStatus = `${successCount}ê°œ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤íŒ¨: ${failedFiles.length}ê°œ`;
                                this.uploadSuccess = false;
                            } else {
                                this.uploadStatus = 'ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                                this.uploadSuccess = false;
                            }

                            if (failedFiles.length > 0) {
                                console.error('ì‹¤íŒ¨í•œ íŒŒì¼ë“¤:', failedFiles);
                            }
                        } else {
                            // í…ìŠ¤íŠ¸ ì—…ë¡œë“œ (ê¸°ì¡´ ì½”ë“œ)
                            const response = await fetch('/upload/text', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    title: this.documentTitle,
                                    content: this.documentContent
                                })
                            });

                            if (response.ok) {
                                this.uploadStatus = 'í…ìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!';
                                this.uploadSuccess = true;
                                this.documentTitle = '';
                                this.documentContent = '';
                            } else {
                                const error = await response.json();
                                throw new Error(error.detail || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
                            }
                        }

                        this.refreshStats();
                    } catch (error) {
                        this.uploadStatus = 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
                        this.uploadSuccess = false;
                    } finally {
                        this.uploading = false;
                        this.uploadProgress = 0;
                        this.currentFileIndex = 0;
                        this.totalFiles = 0;
                    }
                },

                async refreshStats() {
                    try {
                        const response = await fetch('/documents/count');
                        if (response.ok) {
                            const result = await response.json();
                            this.documentCount = result.total_documents;
                        }
                    } catch (error) {
                        console.error('í†µê³„ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    }
                },

                async askQuestion() {
                    if (!this.currentQuestion.trim() || this.questioning) return;

                    const question = this.currentQuestion.trim();
                    this.currentQuestion = '';
                    this.questioning = true;

                    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                    this.messages.push({
                        id: Date.now(),
                        type: 'user',
                        content: question,
                        timestamp: new Date().toLocaleTimeString()
                    });

                    // ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€
                    const loadingId = Date.now() + 1;
                    this.messages.push({
                        id: loadingId,
                        type: 'loading',
                        content: '',
                        timestamp: ''
                    });

                    this.scrollToBottom();

                    try {
                        const response = await fetch('/qa', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                question: question,
                                limit: 5,
                                threshold: 0.3,
                                strategy: this.searchStrategy
                            })
                        });

                        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                        this.messages = this.messages.filter(m => m.id !== loadingId);

                        if (response.ok) {
                            const result = await response.json();

                            // AI ì‘ë‹µ ë©”ì‹œì§€ ìƒì„±
                            const assistantMessage = {
                                id: Date.now() + 2,
                                type: 'assistant',
                                content: result.answer,
                                sources: result.context_chunks,
                                timestamp: new Date().toLocaleTimeString(),
                                query_analysis: result.query_analysis,
                                used_documents: result.used_documents
                            };

                            this.messages.push(assistantMessage);
                        } else {
                            throw new Error('ë‹µë³€ ìƒì„± ì‹¤íŒ¨');
                        }
                    } catch (error) {
                        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                        this.messages = this.messages.filter(m => m.id !== loadingId);

                        // ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶”ê°€
                        this.messages.push({
                            id: Date.now() + 3,
                            type: 'assistant',
                            content: 'ì£„ì†¡í•©ë‹ˆë‹¤. ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message,
                            timestamp: new Date().toLocaleTimeString()
                        });
                    } finally {
                        this.questioning = false;
                        this.scrollToBottom();
                    }
                },

                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = document.getElementById('messageContainer');
                        container.scrollTop = container.scrollHeight;
                    });
                },

                async viewChunkContent(source) {
                    this.showFullContent = true;
                    this.loadingFullContent = true;

                    // ì²­í¬ ì •ë³´ ì„¤ì • - undefined ê°’ë“¤ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                    this.fullContentDocument = {
                        title: (source.metadata && source.metadata.title) || 'ì•Œ ìˆ˜ ì—†ëŠ” ë¬¸ì„œ',
                        content: source.content || 'ë‚´ìš© ì—†ìŒ',
                        chunkId: source.unique_chunk_index || `${source.document_id || 'unknown'}#${(source.metadata && source.metadata.chunk_index) || 0}`,
                        documentId: source.document_id || '',
                        chunkIndex: source.metadata && source.metadata.chunk_index,
                        score: source.score || 0,
                        metadata: true
                    };

                    // ë¡œë”© íš¨ê³¼ë¥¼ ìœ„í•œ ì§§ì€ ì§€ì—°
                    setTimeout(() => {
                        this.loadingFullContent = false;
                    }, 200);
                },

                async viewFullContent(documentId, title) {
                    this.showFullContent = true;
                    this.loadingFullContent = true;
                    this.fullContentDocument = {
                        title: title || 'ë¬¸ì„œ ì „ì²´ ë‚´ìš©',
                        content: '',
                        chunkId: '',
                        documentId: '',
                        chunkIndex: null,
                        score: null,
                        metadata: false
                    };

                    try {
                        const response = await fetch(`/documents/${documentId}/content`);
                        if (response.ok) {
                            const result = await response.json();
                            this.fullContentDocument.content = result.content;
                        } else {
                            throw new Error('ë¬¸ì„œ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        this.fullContentDocument.content = 'ì˜¤ë¥˜: ' + error.message;
                    } finally {
                        this.loadingFullContent = false;
                    }
                },

                // ê²€ìƒ‰ ì „ëµ ê´€ë ¨ ë©”ì„œë“œ ì¶”ê°€
                selectBaseStrategy(strategy) {
                    this.baseStrategy = strategy;
                    if (strategy !== 'bm25') {
                        this.selectedAnalyzer = 'none';
                        this.useHybrid = false;
                    }
                    this.updateSearchStrategy();
                },

                selectAnalyzer(analyzer) {
                    this.selectedAnalyzer = analyzer;
                    this.updateSearchStrategy();
                },

                toggleHybrid(hybrid) {
                    this.useHybrid = hybrid;
                    this.updateSearchStrategy();
                },

                updateSearchStrategy() {
                    if (this.baseStrategy === 'bm25') {
                        let strategy = 'bm25';

                        // í˜•íƒœì†Œ ë¶„ì„ê¸° ì¶”ê°€
                        if (this.selectedAnalyzer !== 'none') {
                            strategy += '_' + this.selectedAnalyzer;
                        }

                        // í•˜ì´ë¸Œë¦¬ë“œ ì˜µì…˜ ì¶”ê°€
                        if (this.useHybrid) {
                            strategy += '_hybrid';
                        }

                        this.searchStrategy = strategy;
                    } else {
                        this.searchStrategy = this.baseStrategy;
                    }
                },
            }
        }
    </script>
</body>

</html>